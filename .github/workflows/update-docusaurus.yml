name: Update docusaurus dependencies

on:
  schedule:
    - cron: '0 4 * * *' # every night at 04:00
  workflow_dispatch:

jobs:
  update-docusaurus:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Find latest version
        id: latest-version
        uses: actions/github-script@v6
        with:
          script: |
            var child_process = require('child_process');
            var child = child_process.spawnSync("npm", ['outdated', '--json'], {encoding: 'utf-8'});
            var outdatedDeps = JSON.parse(child.stdout);
            var outdatedDocusaurusDeps = Object.keys(outdatedDeps)
              .filter(dep => dep.startsWith('@docusaurus/'))
              .map(dep => ({name: dep, latest: outdatedDeps[dep].latest}))

            return outdatedDocusaurusDeps;
      - name: Print latest version
        if: steps.latest-version.outputs.result != '[]'
        run: echo "${{steps.latest-version.outputs.result}}"
      - name: Update dependencies
        if: steps.latest-version.outputs.result != '[]'
        uses: actions/github-script@v6
        with:
          script: |
            var deps = JSON.parse('${{ steps.latest-version.outputs.result }}');
            if (deps.length === 0) {
              return;
            }
            var args = deps.map(dep => `${dep.name}@${dep.latest}`);
            exec.exec('npm', ['install', '--save-exact', ...args]);
      - name: Print result
        if: steps.latest-version.outputs.result != '[]'
        run: cat package.json
         
      - name: Create Pull Request
        if: steps.latest-version.outputs.result != '[]'
        id: cpr
        uses: peter-evans/create-pull-request@v4
        with:
          # Use a PAT so GitHub actions are triggered on the PR
          token: ${{ secrets.PAT }}
          commit-message: "Bump docusaurus dependencies"
          branch: 'bump-docusaurus-dependencies'
          delete-branch: true
          base: main
          author: 'sonallux <13821543+sonallux@users.noreply.github.com>'
          title: "Bump docusaurus dependencies"
          body: |
            Bump [docusaurus](https://github.com/facebook/docusaurus/releases) dependencies.
            
            Generated by [this workflow run](https://github.com/sonallux/sonallux.github.io/actions/runs/${{ github.run_id }}).
      - name: Check outputs
        if: steps.latest-version.outputs.result != '[]'
        run: 'echo "Pull Request ${{ steps.cpr.outputs.pull-request-operation }}: ${{ steps.cpr.outputs.pull-request-url }}"'
      - name: Comment on PR
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: actions/github-script@v6
        with:
          github-token: ${{secrets.PAT}}
          script: |
            github.rest.issues.createComment({
              issue_number: ${{ steps.cpr.outputs.pull-request-number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "@sonallux An udate for docusaurus is available!"
            })
